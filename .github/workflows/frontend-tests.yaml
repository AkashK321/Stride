# ============================================================================
# WORKFLOW: Frontend Tests
# ============================================================================
#
# PURPOSE:
#   Run frontend unit tests on pull requests. This workflow runs independently
#   from pr-validation.yaml to keep test execution separate from static analysis.
#
# TRIGGERS:
#   1. Pull request events:
#      - Types: opened, synchronize, reopened
#      - Paths: frontend/**
#      - Runs: Frontend Unit Tests
#
# WORKFLOW FLOW:
#   Pull Request Event (opened/updated)
#       ↓
#   frontend-tests runs
#       ↓
#   [Install Dependencies] → [Run Unit Tests] → [Publish Test Results]
#       ↓
#   [Test results visible on PR]
#
# OUTPUTS:
#   - Test results (published to GitHub PR checks)
#   - Coverage reports (if configured)
#
# DEPENDENCIES:
#   - None (standalone frontend test workflow)
#
# ============================================================================

name: Frontend Tests

on:
  push:
    branches:
      - '**'
    paths:
      - 'frontend/**'
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'frontend/**'
      - '.github/workflows/**'

# Permissions required for test-reporter
permissions:
  contents: read
  checks: write      # Required for test-reporter to create check runs
  pull-requests: write  # Required for PR comments (if test-reporter adds them)

# Prevent multiple concurrent runs on the same PR
concurrency:
  group: frontend-tests-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  frontend-unit-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4
        # Checkout the PR branch (head ref), not the merge commit
        # This ensures we test the PR code, not merged code
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      
      # Step 2: Set up Node.js 20 with npm cache
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      # Step 3: Install dependencies
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      # Step 4: Run unit tests
      - name: Run unit tests
        working-directory: frontend
        run: npm test -- --ci --coverage
      
      # Step 5: Publish test results to GitHub
      - name: Publish test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Frontend Test Results
          path: frontend/coverage/junit.xml
          reporter: jest-junit
          fail-on-error: false
          list-suites: all
          list-tests: all
